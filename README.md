# 中国象棋网络对战
中国象棋网络对战-清华大学计算机科学与技术系程序设计训练课程项目


## 网络通信部分

连接部分：基于 QTcpServer 和 QTcpSocket 建立套接字，initServer() 函数用于启用服务器的监听状态；startConnection() 函数用于向服务器发出连接请求。启用监听状态在获得请求连接的IP地址时，采用了对话框的形式，并加设软键盘，用来帮助用户输入IP地址，采用QSignalMapper将QPushButton发出的信号添加参数，以简化代码。在启用监听和开始连接时，都会向用户弹出窗口，用户可以选择是否继续等待，还是终止当前操作。

通信部分：采用QByteArray类来传递数据，确保数据的准确传输。发送信息时，先发送关键字，在发送有效信息。所以接收信息的函数 recvMessage( ) 要先对应关键字，对应不同关键字调用不同函数。

## 象棋对战部分

棋盘和棋子的绘制均在Widget类（继承自QWidget），重写了Qpaintevent()函数。
记录了棋子信息，棋局时间的参数。

游戏过程：
开始游戏，或从文件中读入残局时，首先设置 Chessman_Coordinate 和 To_Move 数组，定位棋子和每个棋子能够行走的位置；其次初始化各项参数，当所有参数初始化完毕时，调用 paintEvent( ) 函数绘制棋盘。

开始计时，QTimer每次发出信号，主界面显示时间的部件都会更新，当某方时间超过规定上限时，直接导致游戏结束。

响应鼠标点击事件，重写了QMouseEvent( ) 函数，当现在不是我方下棋的时候，点击棋盘将会弹出对话框，提示不是我方落子时间。每当点击棋盘时，通过获取鼠标的坐标来计算点击的是哪一个棋子，并调用To_Move()函数来获取当前棋子可以移动到的位置，重新绘图。当产生有效的落子或吃子的动作时，调用Eat_Chessman()函数，对Chessman_Coordinate 数组进行更新，并向另一端发出信号以同步棋盘。每当棋盘更新时，检测当前是否已经可以判断输赢，是否构成将军局面。若已经可以判断输赢，直接结束游戏，弹出对话框。若出现将军局面，播放声音。

将军局面的检测，检查黑方当前所有的子的可移动位置，若红方主将在可移动位置内，则构成将军局面。同样，也要检查红方的所有子的可移动位置，看黑方主将是否在内。

认输机制，当点击认输按钮时，直接结束游戏，向另一端发送信息，包含认输的关键字。

计时机制，当超出规定时间，直接结束游戏，向另一端发送信息，包含超时关键字。

保存当前棋局，遍历整个棋盘，获得当前所有棋子的位置信息，存到一个数组里，遍历结束后，整理棋子信息，写入文档，同时向另一端发送保存棋局的关键字，使另一端也进行保存操作。

读取残局，客户端读取某个残局，直接向服务器端发送关键字和读取的残局文件名，服务器端也打开残局文件，准备游戏。


